library(dplyr)
library(lmerTest)
library(naturalsort)

datapath <- "/dartfs/rc/lab/S/Scraplab/fSEND/inarr_data/"

parcel_values <- read.csv("/dartfs/rc/lab/S/Scraplab/lindseytepfer/inarr/univariate_parcels/parcel_avg_arr.csv", header = TRUE)

sublist <- list.files(datapath, pattern = "sub")
sublist <- naturalsort(sublist)

# Initialize an array to store t-values (400 parcels Ã— 1000 iterations)
t_value_array <- matrix(NA, nrow = 400, ncol = 1000)

set.seed(0)

for (i in 1:1000) { 
  # Reset lists for each iteration
  parcellist <- vector()
  subidlist <- vector()
  movielist <- vector()
  cliplist <- vector()
  versionlist <- vector()
  silencedlist <- vector()
  
  for (sx in seq_along(sublist)) {
    sub <- sublist[sx]
    flip_version <- sample(c(0,1), 1)
    
    sub_clips <- list.files(paste0(datapath, sub, "/segmented_files/"), pattern = "_IM_")
    sub_clips <- naturalsort(sub_clips)
    
    for (cx in seq_along(sub_clips)) {
      clip <- sub_clips[cx]
      
      for (p in 1:400) {
        if (flip_version == 1) {
          if (grepl("silenced", clip)) {
            silenced <- 0
          } else {
            silenced <- 1
          }
        } else {
          if (grepl("silenced", clip)) {
            silenced <- 1
          } else {
            silenced <- 0
          }
        }
        
        parcellist <- c(parcellist, p)
        silencedlist <- c(silencedlist, silenced)
        subidlist <- c(subidlist, sub)
        
        clip_parts <- strsplit(clip, "_")[[1]]
        movielist <- c(movielist, clip_parts[2])
        cliplist <- c(cliplist, clip_parts[3])
        versionlist <- c(versionlist, strsplit(clip_parts[5], "\\.")[[1]][1])
      }
    }
  }
  
  df <- data.frame(
    avg_column = parcel_values,
    parcel = parcellist,
    sub = subidlist,
    movie = movielist,
    clip = cliplist,
    version = versionlist,
    silenced = silencedlist
  )
  
  # For each parcel, fit the model and store the t-value
  for (p in 0:399) {  # Changed from 0:399 to 1:400 for R indexing
    filtered_parcel <- filter(df, parcel == p)
    model <- lmer(avg_column ~ silenced + (1 | sub) + (1 | clip:movie), data = filtered_parcel)
    coefs <- summary(model)$coefficients
    t_value_array[p+1, i] <- coefs["silenced", "t value"]  # Store t-value
  }
  
  # Print progress
  if (i %% 10 == 0) {
    cat("Completed iteration:", i, "\n")
  }
}

# Save the t-value array as a CSV file
write.csv(t_value_array, "t_values_array.csv", row.names = FALSE)

# Print confirmation
cat("T-value array saved as 't_values_array.csv'\n")